{"title":"[Source]用于Raspberry Pi的简易bootloader","url":"raspberrypi-diy-bootloader-source/index.html","content":"<blockquote>\n<p>设计思路请参看 <a href=\"http://www.nilennoct.com/raspberrypi-diy-bootloader/\" target=\"_blank\" rel=\"external\">用于Raspberry Pi的简易bootloader</a></p>\n</blockquote>\n<figure class=\"highlight c\"><figcaption><span>bootloader05.c</span><a href=\"https://gist.github.com/nilennoct/5597400\" target=\"_blank\" rel=\"external\">link</a></figcaption><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div><div class=\"line\">255</div><div class=\"line\">256</div><div class=\"line\">257</div><div class=\"line\">258</div><div class=\"line\">259</div><div class=\"line\">260</div><div class=\"line\">261</div><div class=\"line\">262</div><div class=\"line\">263</div><div class=\"line\">264</div><div class=\"line\">265</div><div class=\"line\">266</div><div class=\"line\">267</div><div class=\"line\">268</div><div class=\"line\">269</div><div class=\"line\">270</div><div class=\"line\">271</div><div class=\"line\">272</div><div class=\"line\">273</div><div class=\"line\">274</div><div class=\"line\">275</div><div class=\"line\">276</div><div class=\"line\">277</div><div class=\"line\">278</div><div class=\"line\">279</div><div class=\"line\">280</div><div class=\"line\">281</div><div class=\"line\">282</div><div class=\"line\">283</div><div class=\"line\">284</div><div class=\"line\">285</div><div class=\"line\">286</div><div class=\"line\">287</div><div class=\"line\">288</div><div class=\"line\">289</div><div class=\"line\">290</div><div class=\"line\">291</div><div class=\"line\">292</div><div class=\"line\">293</div><div class=\"line\">294</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//-------------------------------------------------------------------------</span></div><div class=\"line\"><span class=\"comment\">//-------------------------------------------------------------------------</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">// The raspberry pi firmware at the time this was written defaults</span></div><div class=\"line\"><span class=\"comment\">// loading at address 0x8000.  Although this bootloader could easily</span></div><div class=\"line\"><span class=\"comment\">// load at 0x0000, it loads at 0x8000 so that the same binaries built</span></div><div class=\"line\"><span class=\"comment\">// for the SD card work with this bootloader.  Change the ARMBASE</span></div><div class=\"line\"><span class=\"comment\">// below to use a different location.</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">define</span> ARMBASE 0x8000</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">define</span> LOAD    0x00</span></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">define</span> GO      0x01</span></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">define</span> PEEK    0x02</span></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">define</span> POKE    0x03</span></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">define</span> VERIFY  0x04</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> PUT32 ( <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> PUT16 ( <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> PUT8 ( <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span>, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> GET32 ( <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> GET8 ( <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> GETPC ( <span class=\"keyword\">void</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> BRANCHTO ( <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> dummy ( <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> );</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> uart_init ( <span class=\"keyword\">void</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> uart_lcr ( <span class=\"keyword\">void</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> uart_flush ( <span class=\"keyword\">void</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> uart_send ( <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> uart_recv ( <span class=\"keyword\">void</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> hexstring ( <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> hexstrings ( <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> timer_init ( <span class=\"keyword\">void</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> timer_tick ( <span class=\"keyword\">void</span> );</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">void</span> timer_init ( <span class=\"keyword\">void</span> );</div><div class=\"line\"><span class=\"keyword\">extern</span> <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> timer_tick ( <span class=\"keyword\">void</span> );</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> <span class=\"built_in\">puts</span>(<span class=\"keyword\">char</span>* s);</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//------------------------------------------------------------------------</span></div><div class=\"line\"><span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> xstring[<span class=\"number\">256</span>];</div><div class=\"line\"><span class=\"comment\">//------------------------------------------------------------------------</span></div><div class=\"line\"><span class=\"keyword\">int</span> notmain ( <span class=\"keyword\">void</span> ) {</div><div class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> ra;</div><div class=\"line\">    <span class=\"comment\">//unsigned int rb;</span></div><div class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> rx;</div><div class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> addr;</div><div class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> block;</div><div class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> state;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> crc;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> error_addr;</div><div class=\"line\"></div><div class=\"line\">    uart_init();</div><div class=\"line\">    hexstring(<span class=\"number\">0x12345678</span>);</div><div class=\"line\">    hexstring(GETPC());</div><div class=\"line\">    hexstring(ARMBASE);</div><div class=\"line\">    <span class=\"built_in\">puts</span>(<span class=\"string\">\"Hello World!\"</span>);</div><div class=\"line\">    uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">    timer_init();</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//SOH 0x01</span></div><div class=\"line\"><span class=\"comment\">//ACK 0x06</span></div><div class=\"line\"><span class=\"comment\">//NAK 0x15</span></div><div class=\"line\"><span class=\"comment\">//EOT 0x04</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//block numbers start with 1</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//132 byte packet</span></div><div class=\"line\"><span class=\"comment\">//starts with SOH</span></div><div class=\"line\"><span class=\"comment\">//block number byte</span></div><div class=\"line\"><span class=\"comment\">//255-block number</span></div><div class=\"line\"><span class=\"comment\">//128 bytes of data</span></div><div class=\"line\"><span class=\"comment\">//checksum byte (whole packet)</span></div><div class=\"line\"><span class=\"comment\">//a single EOT instead of SOH when done, send an ACK on it too</span></div><div class=\"line\">    addr=ARMBASE;</div><div class=\"line\">    error_addr = <span class=\"number\">0</span>;</div><div class=\"line\">    block=<span class=\"number\">1</span>;</div><div class=\"line\">    state=<span class=\"number\">0</span>;</div><div class=\"line\">    crc=<span class=\"number\">0</span>;</div><div class=\"line\">    rx=timer_tick();</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">while</span>(<span class=\"number\">1</span>) {</div><div class=\"line\">        ra=timer_tick();</div><div class=\"line\">        <span class=\"keyword\">if</span>((ra-rx)&gt;=<span class=\"number\">4000000</span>) {</div><div class=\"line\">            uart_send(<span class=\"number\">0x15</span>);</div><div class=\"line\">            rx+=<span class=\"number\">4000000</span>;</div><div class=\"line\">        }</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span>((uart_lcr()&<span class=\"number\">0x01</span>)==<span class=\"number\">0</span>) <span class=\"keyword\">continue</span>;</div><div class=\"line\"></div><div class=\"line\">        xstring[state]=uart_recv();</div><div class=\"line\">        rx=timer_tick();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">switch</span>(state) {</div><div class=\"line\">            <span class=\"keyword\">case</span> <span class=\"number\">0</span>: {</div><div class=\"line\">                <span class=\"keyword\">if</span>(xstring[state]==<span class=\"number\">0x01</span>) {</div><div class=\"line\">                    crc=xstring[state];</div><div class=\"line\">                    state++;</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (xstring[state] == <span class=\"number\">0x04</span>) {</div><div class=\"line\">                    uart_send(<span class=\"number\">0x06</span>);</div><div class=\"line\">                    <span class=\"keyword\">if</span> (xstring[<span class=\"number\">1</span>] == LOAD) {</div><div class=\"line\">                        <span class=\"built_in\">puts</span>(<span class=\"string\">\"LOADED\"</span>);</div><div class=\"line\">                        uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">                        uart_flush();</div><div class=\"line\">                    }</div><div class=\"line\">                    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (xstring[<span class=\"number\">1</span>] == VERIFY) {</div><div class=\"line\">                        <span class=\"keyword\">if</span> (error_addr == <span class=\"number\">0</span>) {</div><div class=\"line\">                            <span class=\"built_in\">puts</span>(<span class=\"string\">\"VERIFY SUCCESS\"</span>);</div><div class=\"line\">                            uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">                        }</div><div class=\"line\">                        <span class=\"keyword\">else</span> {</div><div class=\"line\">                            <span class=\"built_in\">puts</span>(<span class=\"string\">\"VERIFY ERROR\"</span>);</div><div class=\"line\">                            <span class=\"built_in\">puts</span>(<span class=\"string\">\"MEM ADDRESS:\"</span>);</div><div class=\"line\">                            hexstring(error_addr);</div><div class=\"line\">                            <span class=\"built_in\">puts</span>(<span class=\"string\">\"MEM VALUE:\"</span>);</div><div class=\"line\">                            hexstring(GET32(error_addr));</div><div class=\"line\">                            uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">                        }</div><div class=\"line\">                        uart_flush();</div><div class=\"line\">                    }</div><div class=\"line\">                    addr = ARMBASE;</div><div class=\"line\">                    error_addr = <span class=\"number\">0</span>;</div><div class=\"line\">                    block = <span class=\"number\">1</span>;</div><div class=\"line\">                    state = <span class=\"number\">0</span>;</div><div class=\"line\">                    crc = <span class=\"number\">0</span>;</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">else</span> {</div><div class=\"line\">                    state=<span class=\"number\">0</span>;</div><div class=\"line\">                    uart_send(<span class=\"number\">0x15</span>);</div><div class=\"line\">                    <span class=\"built_in\">puts</span>(<span class=\"string\">\"INITIAL ERROR\"</span>);</div><div class=\"line\">                    uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">                    uart_flush();</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            }</div><div class=\"line\">            <span class=\"keyword\">case</span> <span class=\"number\">1</span>: {</div><div class=\"line\">                <span class=\"keyword\">if</span> (xstring[<span class=\"number\">1</span>] &gt; VERIFY) {</div><div class=\"line\">                    state = <span class=\"number\">0</span>;</div><div class=\"line\">                    uart_send(<span class=\"number\">0x15</span>);</div><div class=\"line\">                    <span class=\"built_in\">puts</span>(<span class=\"string\">\"INVALID COMMAND\"</span>);</div><div class=\"line\">                    uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">                    uart_flush();</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (xstring[<span class=\"number\">1</span>] == GO) {</div><div class=\"line\">                    state = <span class=\"number\">0</span>;</div><div class=\"line\">                    uart_send(<span class=\"number\">0x06</span>);</div><div class=\"line\">                    <span class=\"built_in\">puts</span>(<span class=\"string\">\"GO TO TARGET\"</span>);</div><div class=\"line\">                    uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">                    uart_flush();</div><div class=\"line\">                    BRANCHTO(ARMBASE);</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (xstring[<span class=\"number\">1</span>] == PEEK || xstring[<span class=\"number\">1</span>] == POKE) {</div><div class=\"line\">                    state = <span class=\"number\">133</span>;</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">else</span> {</div><div class=\"line\">                    state++;</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            }</div><div class=\"line\">            <span class=\"keyword\">case</span> <span class=\"number\">2</span>: {</div><div class=\"line\">                <span class=\"keyword\">if</span>(xstring[state]==block) {</div><div class=\"line\">                    crc+=xstring[state];</div><div class=\"line\">                    state++;</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">else</span> {</div><div class=\"line\">                    state=<span class=\"number\">0</span>;</div><div class=\"line\">                    uart_send(<span class=\"number\">0x15</span>);</div><div class=\"line\">                    <span class=\"built_in\">puts</span>(<span class=\"string\">\"BLOCK ERROR\"</span>);</div><div class=\"line\">                    uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">                    uart_flush();</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            }</div><div class=\"line\">            <span class=\"keyword\">case</span> <span class=\"number\">3</span>: {</div><div class=\"line\">                <span class=\"keyword\">if</span>(xstring[state]==(<span class=\"number\">0xFF</span>-xstring[state-<span class=\"number\">1</span>])) {</div><div class=\"line\">                    crc+=xstring[state];</div><div class=\"line\">                    state++;</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">else</span> {</div><div class=\"line\">                    state=<span class=\"number\">0</span>;</div><div class=\"line\">                    uart_send(<span class=\"number\">0x15</span>);</div><div class=\"line\">                    <span class=\"built_in\">puts</span>(<span class=\"string\">\"BLOCK ERROR\"</span>);</div><div class=\"line\">                    uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">                    uart_flush();</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            }</div><div class=\"line\">            <span class=\"keyword\">case</span> <span class=\"number\">132</span>: {</div><div class=\"line\">                crc&=<span class=\"number\">0xFF</span>;</div><div class=\"line\">                <span class=\"keyword\">if</span>(xstring[state]==crc) {</div><div class=\"line\">                    <span class=\"keyword\">if</span> (xstring[<span class=\"number\">1</span>] == LOAD) {</div><div class=\"line\">                        <span class=\"keyword\">for</span>(ra=<span class=\"number\">0</span>;ra&lt;<span class=\"number\">128</span>;ra++) {</div><div class=\"line\">                            PUT8(addr++,xstring[ra+<span class=\"number\">4</span>]);</div><div class=\"line\">                        }</div><div class=\"line\">                        uart_send(<span class=\"number\">0x06</span>);</div><div class=\"line\">                    }</div><div class=\"line\">                    <span class=\"keyword\">else</span> {</div><div class=\"line\">                        <span class=\"keyword\">for</span> (ra = <span class=\"number\">0</span>; ra &lt; <span class=\"number\">128</span>; ra++, addr++) {</div><div class=\"line\">                            <span class=\"keyword\">if</span> (xstring[ra + <span class=\"number\">4</span>] != (GET8(addr) & <span class=\"number\">0xff</span>)) {</div><div class=\"line\">                                error_addr = addr;</div><div class=\"line\">                                <span class=\"keyword\">break</span>;</div><div class=\"line\">                            }</div><div class=\"line\">                        }</div><div class=\"line\">                        uart_send(<span class=\"number\">0x06</span>);</div><div class=\"line\">                    }</div><div class=\"line\">                    block=(block+<span class=\"number\">1</span>) & <span class=\"number\">0xFF</span>;</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">else</span> {</div><div class=\"line\">                    uart_send(<span class=\"number\">0x15</span>);</div><div class=\"line\">                    <span class=\"built_in\">puts</span>(<span class=\"string\">\"CRC ERROR\"</span>);</div><div class=\"line\">                    uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">                    uart_flush();</div><div class=\"line\">                }</div><div class=\"line\">                state=<span class=\"number\">0</span>;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            }</div><div class=\"line\">            <span class=\"keyword\">case</span> <span class=\"number\">136</span>: {</div><div class=\"line\">                <span class=\"keyword\">if</span> (xstring[<span class=\"number\">1</span>] == PEEK) {</div><div class=\"line\">                    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> peek_addr = <span class=\"number\">0</span>;</div><div class=\"line\">                    <span class=\"keyword\">for</span> (ra = <span class=\"number\">0</span>; ra &lt; <span class=\"number\">4</span>; ra++) {</div><div class=\"line\">                        peek_addr = peek_addr &lt;&lt; <span class=\"number\">8</span> | xstring[ra + <span class=\"number\">133</span>];</div><div class=\"line\">                    }</div><div class=\"line\">                    uart_send(<span class=\"number\">0x06</span>);</div><div class=\"line\">                    <span class=\"built_in\">puts</span>(<span class=\"string\">\"PEEK\"</span>);</div><div class=\"line\">                    hexstring(GET32(peek_addr));</div><div class=\"line\">                    uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">                    uart_flush();</div><div class=\"line\">                    state = <span class=\"number\">0</span>;</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">else</span> {</div><div class=\"line\">                    state++;</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            }</div><div class=\"line\">            <span class=\"keyword\">case</span> <span class=\"number\">140</span>: {</div><div class=\"line\">                <span class=\"keyword\">if</span> (xstring[<span class=\"number\">1</span>] == POKE) {</div><div class=\"line\">                    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> poke_addr = <span class=\"number\">0x00000000</span>;</div><div class=\"line\">                    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> poke_data = <span class=\"number\">0</span>;</div><div class=\"line\">                    <span class=\"keyword\">for</span> (ra = <span class=\"number\">0</span>; ra &lt; <span class=\"number\">4</span>; ra++) {</div><div class=\"line\">                        poke_addr = poke_addr &lt;&lt; <span class=\"number\">8</span> | xstring[ra + <span class=\"number\">133</span>];</div><div class=\"line\">                        poke_data = poke_data &lt;&lt; <span class=\"number\">8</span> | xstring[ra + <span class=\"number\">137</span>];</div><div class=\"line\">                    }</div><div class=\"line\">                    uart_send(<span class=\"number\">0x06</span>);</div><div class=\"line\">                    <span class=\"built_in\">puts</span>(<span class=\"string\">\"POKE\"</span>);</div><div class=\"line\">                    PUT32(poke_addr, poke_data);</div><div class=\"line\">                    uart_send(<span class=\"number\">0x04</span>);</div><div class=\"line\">                    uart_flush();</div><div class=\"line\">                    state = <span class=\"number\">0</span>;</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">else</span> {</div><div class=\"line\">                    state = <span class=\"number\">0</span>;</div><div class=\"line\">                }</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            }</div><div class=\"line\">            <span class=\"keyword\">default</span>: {</div><div class=\"line\">                crc+=xstring[state];</div><div class=\"line\">                state++;</div><div class=\"line\">                <span class=\"keyword\">break</span>;</div><div class=\"line\">            }</div><div class=\"line\">        }</div><div class=\"line\">    }</div><div class=\"line\">    <span class=\"keyword\">return</span>(<span class=\"number\">0</span>);</div><div class=\"line\">}</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">void</span> <span class=\"built_in\">puts</span>(<span class=\"keyword\">char</span>* s) {</div><div class=\"line\">    <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">while</span>(s[i] != <span class=\"string\">'\\0'</span>) {</div><div class=\"line\">        uart_send(s[i++]);</div><div class=\"line\">    }</div><div class=\"line\">    uart_send(<span class=\"number\">0x0D</span>);</div><div class=\"line\">    uart_send(<span class=\"number\">0x0A</span>);</div><div class=\"line\">}</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//-------------------------------------------------------------------------</span></div><div class=\"line\"><span class=\"comment\">//-------------------------------------------------------------------------</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">//-------------------------------------------------------------------------</span></div><div class=\"line\"><span class=\"comment\">//</span></div><div class=\"line\"><span class=\"comment\">// Copyright (c) 2012 David Welch dwelch@dwelch.com</span></div><div class=\"line\"><span class=\"comment\">//</span></div><div class=\"line\"><span class=\"comment\">// Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</span></div><div class=\"line\"><span class=\"comment\">//</span></div><div class=\"line\"><span class=\"comment\">// The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</span></div><div class=\"line\"><span class=\"comment\">//</span></div><div class=\"line\"><span class=\"comment\">// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span></div><div class=\"line\"><span class=\"comment\">//</span></div><div class=\"line\"><span class=\"comment\">//-------------------------------------------------------------------------</span></div></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight gas\"><figcaption><span>vectors.s</span><a href=\"https://gist.github.com/nilennoct/5597408\" target=\"_blank\" rel=\"external\">link</a></figcaption><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">;@<span class=\"comment\">-------------------------------------------------------------------------</span></div><div class=\"line\">;@<span class=\"comment\">-------------------------------------------------------------------------</span></div><div class=\"line\"></div><div class=\"line\">.globl _start</div><div class=\"line\">_start:</div><div class=\"line\">    b skip</div><div class=\"line\"></div><div class=\"line\">.space <span class=\"number\">0x200000</span>-<span class=\"number\">0x8004</span>,<span class=\"number\">0</span></div><div class=\"line\"></div><div class=\"line\">skip:</div><div class=\"line\">    mov sp,#<span class=\"number\">0x08000000</span></div><div class=\"line\">    bl notmain</div><div class=\"line\">hang: b hang</div><div class=\"line\"></div><div class=\"line\">.globl PUT32</div><div class=\"line\">PUT32:</div><div class=\"line\">    str r1,[r0]</div><div class=\"line\">    bx lr</div><div class=\"line\"></div><div class=\"line\">.globl PUT16</div><div class=\"line\">PUT16:</div><div class=\"line\">    strh r1,[r0]</div><div class=\"line\">    bx lr</div><div class=\"line\"></div><div class=\"line\">.globl PUT8</div><div class=\"line\">PUT8:</div><div class=\"line\">    strb r1,[r0]</div><div class=\"line\">    bx lr</div><div class=\"line\"></div><div class=\"line\">.globl GET32</div><div class=\"line\">GET32:</div><div class=\"line\">    ldr r0,[r0]</div><div class=\"line\">    bx lr</div><div class=\"line\"></div><div class=\"line\">.globl GET8</div><div class=\"line\">GET8:</div><div class=\"line\">    ldrb r0,[r0]</div><div class=\"line\">    bx lr</div><div class=\"line\"></div><div class=\"line\">.globl GETPC</div><div class=\"line\">GETPC:</div><div class=\"line\">    mov r0,lr</div><div class=\"line\">    bx lr</div><div class=\"line\"></div><div class=\"line\">.globl BRANCHTO</div><div class=\"line\">BRANCHTO:</div><div class=\"line\">    bx r0</div><div class=\"line\"></div><div class=\"line\">.globl dummy</div><div class=\"line\">dummy:</div><div class=\"line\">    bx lr</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">;@<span class=\"comment\">-------------------------------------------------------------------------</span></div><div class=\"line\">;@<span class=\"comment\">-------------------------------------------------------------------------</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">;@<span class=\"comment\">-------------------------------------------------------------------------</span></div><div class=\"line\">;@</div><div class=\"line\">;@ Copyright (c) <span class=\"number\">2012</span> David Welch dwelch@dwelch.com</div><div class=\"line\">;@</div><div class=\"line\">;@ Permission <span class=\"keyword\">is</span> hereby granted, free <span class=\"keyword\">of</span> charge, <span class=\"keyword\">to</span> any person obtaining a copy <span class=\"keyword\">of</span> this software <span class=\"keyword\">and</span> associated documentation files (the <span class=\"string\">\"Software\"</span>), <span class=\"keyword\">to</span> deal <span class=\"keyword\">in</span> the Software without restriction, including without limitation the rights <span class=\"keyword\">to</span> <span class=\"keyword\">use</span>, copy, modify, merge, publish, distribute, sublicense, <span class=\"keyword\">and</span>/<span class=\"keyword\">or</span> sell copies <span class=\"keyword\">of</span> the Software, <span class=\"keyword\">and</span> <span class=\"keyword\">to</span> permit persons <span class=\"keyword\">to</span> whom the Software <span class=\"keyword\">is</span> furnished <span class=\"keyword\">to</span> do so, subject <span class=\"keyword\">to</span> the following conditions:</div><div class=\"line\">;@</div><div class=\"line\">;@ The above copyright notice <span class=\"keyword\">and</span> this permission notice shall be included <span class=\"keyword\">in</span> <span class=\"keyword\">all</span> copies <span class=\"keyword\">or</span> substantial portions <span class=\"keyword\">of</span> the Software.</div><div class=\"line\">;@</div><div class=\"line\">;@ THE SOFTWARE <span class=\"keyword\">IS</span> PROVIDED <span class=\"string\">\"AS IS\"</span>, WITHOUT WARRANTY <span class=\"keyword\">OF</span> ANY KIND, EXPRESS <span class=\"keyword\">OR</span> IMPLIED, INCLUDING BUT <span class=\"keyword\">NOT</span> LIMITED <span class=\"keyword\">TO</span> THE WARRANTIES <span class=\"keyword\">OF</span> MERCHANTABILITY, FITNESS <span class=\"keyword\">FOR</span> A PARTICULAR PURPOSE <span class=\"keyword\">AND</span> NONINFRINGEMENT. <span class=\"keyword\">IN</span> NO EVENT SHALL THE AUTHORS <span class=\"keyword\">OR</span> COPYRIGHT HOLDERS BE LIABLE <span class=\"keyword\">FOR</span> ANY CLAIM, DAMAGES <span class=\"keyword\">OR</span> OTHER LIABILITY, WHETHER <span class=\"keyword\">IN</span> AN ACTION <span class=\"keyword\">OF</span> CONTRACT, TORT <span class=\"keyword\">OR</span> OTHERWISE, ARISING FROM, <span class=\"keyword\">OUT</span> <span class=\"keyword\">OF</span> <span class=\"keyword\">OR</span> <span class=\"keyword\">IN</span> CONNECTION <span class=\"keyword\">WITH</span> THE SOFTWARE <span class=\"keyword\">OR</span> THE <span class=\"keyword\">USE</span> <span class=\"keyword\">OR</span> OTHER DEALINGS <span class=\"keyword\">IN</span> THE SOFTWARE.</div><div class=\"line\">;@</div><div class=\"line\">;@<span class=\"comment\">-------------------------------------------------------------------------</span></div></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight python\"><figcaption><span>xmodem-loader.py</span><a href=\"https://gist.github.com/nilennoct/5597404\" target=\"_blank\" rel=\"external\">link</a></figcaption><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">#Need to install the PySerial library first</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">import</span> sys, getopt</div><div class=\"line\"><span class=\"keyword\">import</span> serial</div><div class=\"line\"><span class=\"keyword\">import</span> time</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">open</span><span class=\"params\">(aport=<span class=\"string\">'/dev/ttyUSB0'</span>, abaudrate=<span class=\"number\">115200</span>)</span> :</span></div><div class=\"line\">\t<span class=\"keyword\">return</span> serial.Serial(</div><div class=\"line\">\t\tport=aport,</div><div class=\"line\">\t\tbaudrate=abaudrate,     <span class=\"comment\"># baudrate</span></div><div class=\"line\">\t\tbytesize=<span class=\"number\">8</span>,             <span class=\"comment\"># number of databits</span></div><div class=\"line\">\t\tparity=serial.PARITY_NONE,</div><div class=\"line\">\t\tstopbits=<span class=\"number\">1</span>,</div><div class=\"line\">\t\txonxoff=<span class=\"number\">0</span>,              <span class=\"comment\"># enable software flow control</span></div><div class=\"line\">\t\trtscts=<span class=\"number\">0</span>,               <span class=\"comment\"># disable RTS/CTS flow control</span></div><div class=\"line\">\t\ttimeout=<span class=\"keyword\">None</span>               <span class=\"comment\"># set a timeout value, None for waiting forever</span></div><div class=\"line\">\t)</div><div class=\"line\"></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">printLog</span><span class=\"params\">(sp)</span>:</span></div><div class=\"line\">\ttemp = sp.read()</div><div class=\"line\">\t<span class=\"keyword\">while</span> ord(temp) != <span class=\"number\">0x04</span>:</div><div class=\"line\">\t\twrite(temp)</div><div class=\"line\">\t\ttemp = sp.read()</div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">\"__main__\"</span>:</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\"># Import Psyco if available</span></div><div class=\"line\">\t<span class=\"keyword\">try</span>:</div><div class=\"line\">\t\t<span class=\"keyword\">import</span> psyco</div><div class=\"line\">\t\tpsyco.full()</div><div class=\"line\">\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"Using Psyco...\"</span></div><div class=\"line\">\t<span class=\"keyword\">except</span> ImportError:</div><div class=\"line\">\t\t<span class=\"keyword\">pass</span></div><div class=\"line\"></div><div class=\"line\">\tconf = {</div><div class=\"line\">\t\t<span class=\"string\">'port'</span>: <span class=\"string\">'/dev/ttyUSB0'</span>,</div><div class=\"line\">\t\t<span class=\"string\">'baud'</span>: <span class=\"number\">115200</span>,</div><div class=\"line\">\t}</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">try</span>:</div><div class=\"line\">\t\topts, args = getopt.getopt(sys.argv[<span class=\"number\">1</span>:], <span class=\"string\">\"hqVewvrp:b:a:l:\"</span>)</div><div class=\"line\">\t<span class=\"keyword\">except</span> getopt.GetoptError, err:</div><div class=\"line\">\t\t<span class=\"keyword\">print</span> str(err)</div><div class=\"line\">\t\tsys.exit(<span class=\"number\">2</span>)</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">for</span> o, a <span class=\"keyword\">in</span> opts:</div><div class=\"line\">\t\t<span class=\"keyword\">if</span> o == <span class=\"string\">'-p'</span>:</div><div class=\"line\">\t\t\tconf[<span class=\"string\">'port'</span>] = a</div><div class=\"line\">\t\t<span class=\"keyword\">elif</span> o == <span class=\"string\">'-b'</span>:</div><div class=\"line\">\t\t\tconf[<span class=\"string\">'baud'</span>] = eval(a)</div><div class=\"line\">\t\t<span class=\"keyword\">else</span>:</div><div class=\"line\">\t\t\t<span class=\"keyword\">assert</span> <span class=\"keyword\">False</span>, <span class=\"string\">\"unhandled option\"</span></div><div class=\"line\"></div><div class=\"line\">\tsp = open(conf[<span class=\"string\">'port'</span>], conf[<span class=\"string\">'baud'</span>])</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">#\tprint args[0]</span></div><div class=\"line\"><span class=\"comment\">#\tprint conf['port']</span></div><div class=\"line\"><span class=\"comment\">#\tprint conf['baud']</span></div><div class=\"line\"></div><div class=\"line\">\twrite=sys.stdout.write</div><div class=\"line\"></div><div class=\"line\">\tisLoaded = <span class=\"keyword\">False</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"keyword\">while</span> <span class=\"keyword\">True</span>:</div><div class=\"line\">\t\t<span class=\"keyword\">print</span> <span class=\"string\">''</span></div><div class=\"line\">\t\tcmd = raw_input(<span class=\"string\">'&gt;&gt; '</span>).split(<span class=\"string\">' '</span>);</div><div class=\"line\">\t\tsp.flushInput()</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">if</span> cmd[<span class=\"number\">0</span>] == <span class=\"string\">'go'</span>:</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"keyword\">not</span> isLoaded:</div><div class=\"line\">\t\t\t\tconfirm = raw_input(<span class=\"string\">\"No file has been loaded, are you sure to go? [Y/N]\"</span>)</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> confirm == <span class=\"string\">''</span> <span class=\"keyword\">or</span> confirm[<span class=\"number\">0</span>] == <span class=\"string\">'N'</span> <span class=\"keyword\">or</span> confirm[<span class=\"number\">0</span>] == <span class=\"string\">'n'</span>:</div><div class=\"line\">\t\t\t\t\t<span class=\"keyword\">continue</span></div><div class=\"line\"></div><div class=\"line\">\t\t\tsuccess = <span class=\"keyword\">False</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">while</span> success == <span class=\"keyword\">False</span>:</div><div class=\"line\">\t\t\t\tsp.write(chr(<span class=\"number\">0x01</span>))</div><div class=\"line\">\t\t\t\tsp.write(chr(<span class=\"number\">0x01</span>))</div><div class=\"line\">\t\t\t\tsp.flush()</div><div class=\"line\"></div><div class=\"line\">\t\t\t\ttemp=sp.read()</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ord(temp)==<span class=\"number\">0x06</span>:</div><div class=\"line\">\t\t\t\t\tsuccess = <span class=\"keyword\">True</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">else</span>:</div><div class=\"line\">\t\t\t\t\t<span class=\"keyword\">print</span> ord(temp)</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t\tprintLog(sp)</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">elif</span> cmd[<span class=\"number\">0</span>] == <span class=\"string\">'peek'</span>:</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> len(cmd) &lt; <span class=\"number\">2</span>:</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"Incorrect command, should be 'peek addr'\"</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span></div><div class=\"line\"></div><div class=\"line\">\t\t\taddr = int(cmd[<span class=\"number\">1</span>], <span class=\"number\">16</span>) & <span class=\"number\">0xffffffff</span></div><div class=\"line\"></div><div class=\"line\">\t\t\tsuccess = <span class=\"keyword\">False</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">while</span> success == <span class=\"keyword\">False</span>:</div><div class=\"line\">\t\t\t\tsp.write(chr(<span class=\"number\">0x01</span>))</div><div class=\"line\">\t\t\t\tsp.write(chr(<span class=\"number\">0x02</span>))</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>,<span class=\"number\">4</span>):</div><div class=\"line\">\t\t\t\t\tsp.write(chr(addr &gt;&gt; <span class=\"number\">24</span> & <span class=\"number\">0xff</span>))</div><div class=\"line\">\t\t\t\t\taddr = addr &lt;&lt; <span class=\"number\">8</span></div><div class=\"line\"></div><div class=\"line\">\t\t\t\tsp.flush()</div><div class=\"line\"></div><div class=\"line\">\t\t\t\ttemp=sp.read()</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ord(temp)==<span class=\"number\">0x06</span>:</div><div class=\"line\">\t\t\t\t\tsuccess = <span class=\"keyword\">True</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">else</span>:</div><div class=\"line\">\t\t\t\t\t<span class=\"keyword\">print</span> ord(temp)</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t\tprintLog(sp)</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">elif</span> cmd[<span class=\"number\">0</span>] == <span class=\"string\">'poke'</span>:</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> len(cmd) &lt; <span class=\"number\">3</span>:</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"Incorrect command, should be 'poke addr data'\"</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span></div><div class=\"line\"></div><div class=\"line\">\t\t\taddr = int(cmd[<span class=\"number\">1</span>], <span class=\"number\">16</span>) & <span class=\"number\">0xffffffff</span></div><div class=\"line\">\t\t\tdata = int(cmd[<span class=\"number\">2</span>], <span class=\"number\">16</span>) & <span class=\"number\">0xffffffff</span></div><div class=\"line\"></div><div class=\"line\">\t\t\tsuccess = <span class=\"keyword\">False</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">while</span> success == <span class=\"keyword\">False</span>:</div><div class=\"line\">\t\t\t\tsp.write(chr(<span class=\"number\">0x01</span>))</div><div class=\"line\">\t\t\t\tsp.write(chr(<span class=\"number\">0x03</span>))</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>,<span class=\"number\">4</span>):</div><div class=\"line\">\t\t\t\t\tsp.write(chr(addr &gt;&gt; <span class=\"number\">24</span> & <span class=\"number\">0xff</span>))</div><div class=\"line\">\t\t\t\t\taddr = addr &lt;&lt; <span class=\"number\">8</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>,<span class=\"number\">4</span>):</div><div class=\"line\">\t\t\t\t\tsp.write(chr(data &gt;&gt; <span class=\"number\">24</span> & <span class=\"number\">0xff</span>))</div><div class=\"line\">\t\t\t\t\tdata = data &lt;&lt; <span class=\"number\">8</span></div><div class=\"line\"></div><div class=\"line\">\t\t\t\tsp.flush()</div><div class=\"line\"></div><div class=\"line\">\t\t\t\ttemp=sp.read()</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> ord(temp)==<span class=\"number\">0x06</span>:</div><div class=\"line\">\t\t\t\t\tsuccess = <span class=\"keyword\">True</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">else</span>:</div><div class=\"line\">\t\t\t\t\t<span class=\"keyword\">print</span> ord(temp)</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t\tprintLog(sp)</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">elif</span> cmd[<span class=\"number\">0</span>] == <span class=\"string\">'load'</span> <span class=\"keyword\">or</span> cmd[<span class=\"number\">0</span>] == <span class=\"string\">'verify'</span>:</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> len(cmd) &lt; <span class=\"number\">2</span>:</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"Please input the filename\"</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span></div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"keyword\">try</span>:</div><div class=\"line\">\t\t\t\tdata = map(<span class=\"keyword\">lambda</span> c: ord(c), file(cmd[<span class=\"number\">1</span>],<span class=\"string\">\"rb\"</span>).read())</div><div class=\"line\">\t\t\t<span class=\"keyword\">except</span>:</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"File not exist\"</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">continue</span></div><div class=\"line\"></div><div class=\"line\">\t\t\ttemp = sp.read()</div><div class=\"line\">\t\t\tbuf = <span class=\"string\">\"\"</span></div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"comment\"># while ord(temp)!=0x15:</span></div><div class=\"line\">\t\t\t<span class=\"comment\"># \tbuf += temp</span></div><div class=\"line\">\t\t\t<span class=\"comment\"># \ttemp = sp.read()</span></div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"comment\"># print buf</span></div><div class=\"line\">\t\t\tdataLength = len(data)</div><div class=\"line\">\t\t\tblockNum = (dataLength-<span class=\"number\">1</span>)/<span class=\"number\">128</span>+<span class=\"number\">1</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"The size of the image is \"</span>,dataLength,<span class=\"string\">\"!\"</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"Total block number is \"</span>,blockNum,<span class=\"string\">\"!\"</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"Download start,\"</span>,blockNum,<span class=\"string\">\"block(s) in total!\"</span></div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>,blockNum+<span class=\"number\">1</span>):</div><div class=\"line\">\t\t\t\tsuccess = <span class=\"keyword\">False</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">while</span> success == <span class=\"keyword\">False</span>:</div><div class=\"line\">\t\t\t\t\tsp.write(chr(<span class=\"number\">0x01</span>))</div><div class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> cmd[<span class=\"number\">0</span>] == <span class=\"string\">'load'</span>:</div><div class=\"line\">\t\t\t\t\t\tsp.write(chr(<span class=\"number\">0x00</span>))</div><div class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span>:</div><div class=\"line\">\t\t\t\t\t\tsp.write(chr(<span class=\"number\">0x04</span>))</div><div class=\"line\">\t\t\t\t\tsp.write(chr(i&<span class=\"number\">0xFF</span>))</div><div class=\"line\">\t\t\t\t\tsp.write(chr(<span class=\"number\">0xFF</span>-i&<span class=\"number\">0xFF</span>))</div><div class=\"line\">\t\t\t\t\tcrc = <span class=\"number\">0x01</span>+<span class=\"number\">0xFF</span></div><div class=\"line\"></div><div class=\"line\">\t\t\t\t\t<span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>,<span class=\"number\">128</span>):</div><div class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">if</span> len(data)&gt;(i-<span class=\"number\">1</span>)*<span class=\"number\">128</span>+j:</div><div class=\"line\">\t\t\t\t\t\t\tsp.write(chr(data[(i-<span class=\"number\">1</span>)*<span class=\"number\">128</span>+j]))</div><div class=\"line\">\t\t\t\t\t\t\tcrc += data[(i-<span class=\"number\">1</span>)*<span class=\"number\">128</span>+j]</div><div class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">else</span>:</div><div class=\"line\">\t\t\t\t\t\t\tsp.write(chr(<span class=\"number\">0xff</span>))</div><div class=\"line\">\t\t\t\t\t\t\tcrc += <span class=\"number\">0xff</span></div><div class=\"line\"></div><div class=\"line\">\t\t\t\t\tcrc &= <span class=\"number\">0xff</span></div><div class=\"line\">\t\t\t\t\tsp.write(chr(crc))</div><div class=\"line\">\t\t\t\t\tsp.flush()</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t\t<span class=\"comment\"># !important!</span></div><div class=\"line\">\t\t\t\t\t<span class=\"comment\"># time.sleep(0.1)</span></div><div class=\"line\"></div><div class=\"line\">\t\t\t\t\ttemp=sp.read()</div><div class=\"line\">\t\t\t\t\tsp.flushInput()</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t\t<span class=\"keyword\">if</span> ord(temp)==<span class=\"number\">0x06</span>:</div><div class=\"line\">\t\t\t\t\t\tsuccess = <span class=\"keyword\">True</span></div><div class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"Block\"</span>,i,<span class=\"string\">\"has finished!\"</span></div><div class=\"line\">\t\t\t\t\t<span class=\"keyword\">else</span>:</div><div class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">print</span> ord(temp)</div><div class=\"line\">\t\t\t\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"Error,send again!\"</span></div><div class=\"line\"></div><div class=\"line\">\t\t\t\t\t\tprintLog(sp)</div><div class=\"line\"></div><div class=\"line\">\t\t\tsp.write(chr(<span class=\"number\">0x04</span>))</div><div class=\"line\">\t\t\tsp.flush()</div><div class=\"line\">\t\t\ttemp=sp.read()</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span> ord(temp)==<span class=\"number\">0x06</span>:</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (cmd[<span class=\"number\">0</span>] == <span class=\"string\">'load'</span>):</div><div class=\"line\">\t\t\t\t\tisLoaded = <span class=\"keyword\">True</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"Download has finished!\\n\"</span></div><div class=\"line\">\t\t<span class=\"keyword\">elif</span> cmd[<span class=\"number\">0</span>] == <span class=\"string\">'q'</span> <span class=\"keyword\">or</span> cmd[<span class=\"number\">0</span>] == <span class=\"string\">'quit'</span> <span class=\"keyword\">or</span> cmd[<span class=\"number\">0</span>] == <span class=\"string\">'exit'</span>:</div><div class=\"line\">\t\t\tsys.exit(<span class=\"number\">0</span>)</div><div class=\"line\">\t\t<span class=\"keyword\">else</span>:</div><div class=\"line\">\t\t\t<span class=\"keyword\">print</span> <span class=\"string\">\"Invalid command!\"</span></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">\t\tprintLog(sp)</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\"># while True:</span></div><div class=\"line\">\t<span class=\"comment\"># \twrite(sp.read())</span></div><div class=\"line\"></div><div class=\"line\">\tsp.close()</div></pre></td></tr></table></figure>\n\n","layout":"page"}