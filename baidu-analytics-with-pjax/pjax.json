{"title":"让百度统计支持 PJAX","url":"/baidu-analytics-with-pjax/","content":"<p>最近把博客系统迁移到 Hexo 上了，作为一名前端工(zha)程(ma)师(nong)，不得不说 Hexo 的相性更好些。</p>\n<p>重新做了套新皮肤，简单的做了下对 iPhone 访问的优化，同时使用了已不新鲜的 PJAX 技术。不过发现百度统计还没支持 PJAX，只能记录第一次打开的页面。没办法只能拿统计代码开刀了。</p>\n<p>我使用的是百度统计的异步加载模式，整个过程分三步：执行插入页面的异步代码；执行异步加载的<code>hm.js</code>；GET 方式请求<code>hm.gif</code>传递统计信息。后两步肯定是没法改了，那就看看百度统计的异步代码吧。</p>\n<figure class=\"highlight html\"><figcaption><span>百度统计的异步代码</span></figcaption><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"title\">script</span>&gt;</span><span class=\"javascript\"></span></div><div class=\"line\"><span class=\"keyword\">var</span> _hmt = _hmt || [];</div><div class=\"line\">(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>{</div><div class=\"line\">  <span class=\"keyword\">var</span> hm = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"script\"</span>);</div><div class=\"line\">  hm.src = <span class=\"string\">\"//hm.baidu.com/hm.js?/* id here */\"</span>;</div><div class=\"line\">  <span class=\"keyword\">var</span> s = <span class=\"built_in\">document</span>.getElementsByTagName(<span class=\"string\">\"script\"</span>)[<span class=\"number\">0</span>];</div><div class=\"line\">  s.parentNode.insertBefore(hm, s);</div><div class=\"line\">})();</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"title\">script</span>&gt;</span></div></pre></td></tr></table></figure>\n\n<p>好吧突然发现这代码和两年前的一模一样，真稳定= =。代码很简单，新建一个<code>&lt;script&gt;</code>元素，设置<code>src</code>然后插到页面中第一个<code>&lt;script&gt;</code>元素前，剩下的就是<code>hm.js</code>的事了。因此要完成统计工作，实际上只要在每次通过 PJAX 加载后重新加载<code>hm.js</code>就好了。</p>\n<figure class=\"highlight html\"><figcaption><span>修改后的代码</span></figcaption><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"title\">script</span> <span class=\"attribute\">id</span>=<span class=\"value\">\"bd-hm\"</span>&gt;</span><span class=\"javascript\"></span></div><div class=\"line\">    <span class=\"keyword\">var</span> _hmt = _hmt || [];</div><div class=\"line\">    (<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>{</div><div class=\"line\">        <span class=\"keyword\">var</span> hm = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">\"script\"</span>);</div><div class=\"line\">        hm.src = <span class=\"string\">\"//hm.baidu.com/hm.js?/* id here */\"</span>;</div><div class=\"line\">        hm.onload = <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>{</div><div class=\"line\">            <span class=\"comment\">// 清除百度统计的加载标识</span></div><div class=\"line\">            <span class=\"keyword\">delete</span> <span class=\"built_in\">window</span>[<span class=\"string\">\"_bdhm_loaded_/* id here */\"</span>];</div><div class=\"line\">        };</div><div class=\"line\">        <span class=\"keyword\">var</span> s = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">'bd-hm'</span>);</div><div class=\"line\">        s.parentNode.insertBefore(hm, s);</div><div class=\"line\">    })();</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"title\">script</span>&gt;</span></div></pre></td></tr></table></figure>\n\n<p>然后在 layout 模板中把这段代码从<code>&lt;/head&gt;</code>前移到合适的位置，在这套主题中，PJAX 请求完替换的是<code>div#main</code>的内容，因此放到它的<code>&lt;/div&gt;</code>前。给<code>&lt;script&gt;</code>加<code>id=&quot;bd-hm&quot;</code>是为了定位统计代码，总不能每次都还是像之前那样插到<code>&lt;head&gt;</code>里吧？你要不介意我也没话说= =。</p>\n","layout":"post"}