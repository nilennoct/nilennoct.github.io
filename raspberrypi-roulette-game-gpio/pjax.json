{"title":"用Raspberry Pi制作简单的轮盘游戏机","url":"/raspberrypi-roulette-game-gpio/","content":"<blockquote>\n<p>浙江大学嵌入式系统课程</p>\n</blockquote>\n<p>之前在Raspberry Pi上做了许多好玩的事情，但与物理计算却是一点关系也没有。所以这次我们来尝试用RPi做一个简单的轮盘游戏机。因为材料有限，“轮盘”将使用一个2位8段数码管模拟。</p>\n<p>材料准备：</p>\n<ul>\n<li>Raspberry Pi</li>\n<li>面包板一块</li>\n<li>2位8段数码管一个</li>\n<li>按钮2个</li>\n<li>1K~10KΩ电阻2个</li>\n<li>面包线+杜邦线若干</li>\n</ul>\n<p><strong>在RPi上安装wiringPi</strong></p>\n<p>使用串口或SSH连接RPi，输入以下命令安装wiringPi。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ <span class=\"built_in\">cd</span> /tmp/</div><div class=\"line\">$ git clone git://git.drogon.net/wiringPi</div><div class=\"line\">$ <span class=\"built_in\">cd</span> wiringPi</div><div class=\"line\">$ <span class=\"built_in\">sudo</span> ./build</div></pre></td></tr></table></figure>\n\n<p>安装完成后，你可以使用命令<code>gpio -v</code>测试wiringPi是否已经正确安装。<br><a id=\"more\"></a><br><strong>连线</strong></p>\n<p>RPi上的GPIO与wiringPi中的Pin的对应关系可以参看下表。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">wiringPi Pin</th>\n<th style=\"text-align:center\">BCM GPIO</th>\n<th style=\"text-align:center\">Name</th>\n<th style=\"text-align:center\">Header</th>\n<th style=\"text-align:center\">Name</th>\n<th style=\"text-align:center\">BCM GPIO</th>\n<th style=\"text-align:center\">wiringPi Pin</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">3.3v</td>\n<td style=\"text-align:center\">1 &#124; 2</td>\n<td style=\"text-align:center\">5v</td>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">–</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">8</td>\n<td style=\"text-align:center\">R1:0/R2:2</td>\n<td style=\"text-align:center\">SDA0</td>\n<td style=\"text-align:center\">3 &#124; 4</td>\n<td style=\"text-align:center\">5v</td>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">–</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">9</td>\n<td style=\"text-align:center\">R1:1/R2:3</td>\n<td style=\"text-align:center\">SCL0</td>\n<td style=\"text-align:center\">5 &#124; 6</td>\n<td style=\"text-align:center\">0v</td>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">–</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">7</td>\n<td style=\"text-align:center\">4</td>\n<td style=\"text-align:center\">GPIO7</td>\n<td style=\"text-align:center\">7 &#124; 8</td>\n<td style=\"text-align:center\">TxD</td>\n<td style=\"text-align:center\">14</td>\n<td style=\"text-align:center\">15</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">0v</td>\n<td style=\"text-align:center\">9 &#124; 10</td>\n<td style=\"text-align:center\">RxD</td>\n<td style=\"text-align:center\">15</td>\n<td style=\"text-align:center\">16</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">0</td>\n<td style=\"text-align:center\">17</td>\n<td style=\"text-align:center\">GPIO0</td>\n<td style=\"text-align:center\">11 &#124; 12</td>\n<td style=\"text-align:center\">GPIO1</td>\n<td style=\"text-align:center\">18</td>\n<td style=\"text-align:center\">1</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">2</td>\n<td style=\"text-align:center\">R1:21/R2:27</td>\n<td style=\"text-align:center\">GPIO2</td>\n<td style=\"text-align:center\">13 &#124; 14</td>\n<td style=\"text-align:center\">0v</td>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">–</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">3</td>\n<td style=\"text-align:center\">22</td>\n<td style=\"text-align:center\">GPIO3</td>\n<td style=\"text-align:center\">15 &#124; 16</td>\n<td style=\"text-align:center\">GPIO4</td>\n<td style=\"text-align:center\">23</td>\n<td style=\"text-align:center\">4</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">3.3v</td>\n<td style=\"text-align:center\">17 &#124; 18</td>\n<td style=\"text-align:center\">GPIO5</td>\n<td style=\"text-align:center\">24</td>\n<td style=\"text-align:center\">5</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">12</td>\n<td style=\"text-align:center\">10</td>\n<td style=\"text-align:center\">MOSI</td>\n<td style=\"text-align:center\">19 &#124; 20</td>\n<td style=\"text-align:center\">0v</td>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">–</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">13</td>\n<td style=\"text-align:center\">9</td>\n<td style=\"text-align:center\">MISO</td>\n<td style=\"text-align:center\">21 &#124; 22</td>\n<td style=\"text-align:center\">GPIO6</td>\n<td style=\"text-align:center\">25</td>\n<td style=\"text-align:center\">6</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">14</td>\n<td style=\"text-align:center\">11</td>\n<td style=\"text-align:center\">SCLK</td>\n<td style=\"text-align:center\">23 &#124; 24</td>\n<td style=\"text-align:center\">CE0</td>\n<td style=\"text-align:center\">8</td>\n<td style=\"text-align:center\">10</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">–</td>\n<td style=\"text-align:center\">0v</td>\n<td style=\"text-align:center\">25 &#124; 26</td>\n<td style=\"text-align:center\">CE1</td>\n<td style=\"text-align:center\">7</td>\n<td style=\"text-align:center\">11</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>更多信息请参看<a href=\"https://projects.drogon.net/raspberry-pi/wiringpi/pins/\" target=\"_blank\" rel=\"external\">wiringPi Pins</a></p>\n</blockquote>\n<p>了解了GPIO排布后，开始连接各个元件，连线结果如下图。</p>\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/06/Rolb.png\" alt=\"Wire_IMG\"></p>\n<blockquote>\n<p><strong>需要注意的是，我们使用的面包板上的XY两行不是全部连通的，经我测试是分成了3-4-3三组，如果程序运行后不停地出现Start &amp; Stop，请检查XY两行上的线是否在同一组内。</strong></p>\n</blockquote>\n<p><strong>编写控制代码<code>roll.c</code></strong></p>\n<figure class=\"highlight c\"><figcaption><span>roll.c</span></figcaption><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">include</span> &lt;wiringPi.h&gt;</span></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">include</span> &lt;stdio.h&gt;</span></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">include</span> &lt;stdlib.h&gt;</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">define</span> DIGIT0 8</span></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">define</span> DIGIT1 9</span></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">define</span> BTN0 10</span></div><div class=\"line\"><span class=\"preprocessor\">#<span class=\"keyword\">define</span> BTN1 11</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"keyword\">int</span> main() {</div><div class=\"line\">    <span class=\"keyword\">int</span> pin;</div><div class=\"line\">    <span class=\"keyword\">int</span> m = <span class=\"number\">0</span>, n = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">int</span> flag = <span class=\"number\">1</span>;</div><div class=\"line\">    <span class=\"keyword\">int</span> run = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> time0 = <span class=\"number\">0</span>, time1 = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">char</span> digit[<span class=\"number\">10</span>][<span class=\"number\">8</span>] = {</div><div class=\"line\">        {<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>}</div><div class=\"line\">    };</div><div class=\"line\">    <span class=\"keyword\">char</span> roll[<span class=\"number\">6</span>][<span class=\"number\">8</span>] = {</div><div class=\"line\">        {<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>},</div><div class=\"line\">        {<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>,<span class=\"number\">0</span>,<span class=\"number\">1</span>,<span class=\"number\">1</span>},</div><div class=\"line\">    };</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span> (wiringPiSetup () == -<span class=\"number\">1</span>)</div><div class=\"line\">        <span class=\"built_in\">exit</span> (<span class=\"number\">1</span>) ;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">for</span> (pin = <span class=\"number\">0</span> ; pin &lt; <span class=\"number\">8</span> ; ++pin) {</div><div class=\"line\">        pinMode (pin, OUTPUT) ;</div><div class=\"line\">        digitalWrite(pin, HIGH);</div><div class=\"line\">    }</div><div class=\"line\"></div><div class=\"line\">    pinMode(DIGIT0, OUTPUT);</div><div class=\"line\">    pinMode(DIGIT1, OUTPUT);</div><div class=\"line\">    pinMode(BTN0, INPUT);</div><div class=\"line\">    pinMode(BTN1, INPUT);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"number\">1</span>) {</div><div class=\"line\">        time1 = millis();</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (digitalRead(BTN0) && run == <span class=\"number\">0</span>) {</div><div class=\"line\">            <span class=\"built_in\">puts</span>(<span class=\"string\">\"Start!\"</span>);</div><div class=\"line\">            run = <span class=\"number\">1</span>;</div><div class=\"line\">            m = <span class=\"number\">0</span>;</div><div class=\"line\">            n = <span class=\"number\">0</span>;</div><div class=\"line\">            time0 = millis();</div><div class=\"line\">        }</div><div class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (digitalRead(BTN1) && run == <span class=\"number\">1</span>) {</div><div class=\"line\">            <span class=\"built_in\">puts</span>(<span class=\"string\">\"Stop!\"</span>);</div><div class=\"line\">            run = <span class=\"number\">0</span>;</div><div class=\"line\">        }</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">if</span> (time1 - time0 &gt;= <span class=\"number\">50</span> && run == <span class=\"number\">1</span>) {</div><div class=\"line\">            time0 = time1;</div><div class=\"line\">            <span class=\"built_in\">printf</span>(<span class=\"string\">\"%d\\n\"</span>, n);</div><div class=\"line\">            m = ++m % <span class=\"number\">6</span>;</div><div class=\"line\">            n = ++n % <span class=\"number\">10</span>;</div><div class=\"line\">        }</div><div class=\"line\"></div><div class=\"line\">        <span class=\"keyword\">for</span> (pin = <span class=\"number\">0</span>; pin &lt; <span class=\"number\">8</span>; pin++) {</div><div class=\"line\">            digitalWrite(pin, flag ? digit[n][pin] : roll[m][pin]);</div><div class=\"line\">        }</div><div class=\"line\"></div><div class=\"line\">        digitalWrite(DIGIT0, flag);</div><div class=\"line\">        digitalWrite(DIGIT1, (flag = <span class=\"number\">1</span> - flag));</div><div class=\"line\">        delay(<span class=\"number\">10</span>);</div><div class=\"line\">    }</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</div><div class=\"line\">}</div></pre></td></tr></table></figure>\n\n<p>保存后执行以下命令编译并运行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ gcc roll.c -o roll -lwiringPi</div><div class=\"line\">$ <span class=\"built_in\">sudo</span> ./roll</div></pre></td></tr></table></figure>\n\n<p><strong>测试结果</strong></p>\n<p>在RPi上运行控制程序后，按一下连线图中左边的按钮，可以看到左边的数码管LED一次点亮如同旋转起来一般，右边的数码管则显示依次增大的数字，同时终端中同步输出当前显示的数字。若按一下右边的按钮则变化将停止。再按左边的按钮可以重新开始。</p>\n<p>具体效果可观看视频^_^</p>\n<iframe height=\"480\" width=\"640\" src=\"http://player.youku.com/embed/XNTY5MTQ1ODg4\" frameborder=\"0\" allowfullscreen></iframe>\n\n<p><strong>部分原理说明</strong></p>\n<ul>\n<li>按键处理</li>\n</ul>\n<p>通常情况下，在使用按键时只需将按键的一端接到3.3V上，另一端接到GPIO口上，通过读取GPIO口的电压值就可以得到按键的通断状态。但在某些特殊环境下，仅仅是把手靠近开关就可能在GPIO上读到高电平，这是因为电路中没有下拉电阻，使得外界干扰影响了对按键的判断。</p>\n<p>如下图所示是一个下拉电阻的常见接法。</p>\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/06/btn_pull_down.png\" alt=\"Pull_Down\"></p>\n<p>在GPIO口与GND之间接一个1K-10KΩ的电阻。当外界有干扰源的时候，干扰源在通向GND的过程中，会被电阻消耗掉，保证按键状态检测的准确性。</p>\n<ul>\n<li>2位8段数码管的使用</li>\n</ul>\n<p>实验中使用的是一个共阳极数码管，其内部电路如下图所示：</p>\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/06/dgt_sgmt_line.png\" alt=\"Segment_Display_Line\"></p>\n<p>另外此2位数码管的引脚位置如下图所示：</p>\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/06/dgt_sgmt_pin.png\" alt=\"Segment_Display_Pin\"></p>\n<p>连线时与内部电路对照着即可，其中5、10为两个数位的控制位，送入高电平时会点亮相应数位。需要注意的是引脚的顺序和数码管上LED的排布顺序不一致，连线时要注意。</p>\n","layout":"post"}