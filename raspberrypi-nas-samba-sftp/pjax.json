{"title":"在RaspberryPi上搭建NAS","url":"/raspberrypi-nas-samba-sftp/","content":"<blockquote>\n<p>浙江大学嵌入式系统课程</p>\n</blockquote>\n<p>给RPi连接上移动硬盘，可以很方便的将其变为NAS（Network Attached Storage）供远程使用。</p>\n<p><strong>连接移动硬盘</strong></p>\n<p>在连接移动硬盘时遇到了一点问题，就是RPi的USB输出功率太小，即使移动硬盘的数据口和供电口（在同一条USB线上）都插在RPi上也依然带不动移动硬盘。最后我把移动硬盘的供电口插在了笔记本上移动硬盘才能正常使用。</p>\n<p>所在若是你在连接移动硬盘后无法在/dev目录中找到设备，请检查移动硬盘供电是否充足。</p>\n<p>因为我是通过ssh连接RPi的，接上移动硬盘后RPi并没有自动挂载。输入如下命令挂载。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">sudo</span> mkdir /media/NAS</div><div class=\"line\"><span class=\"built_in\">sudo</span> mount -o uid=pi,gid=pi /dev/sda5 /media/NAS</div></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>现在就可以在/media/NAS目录下看到移动硬盘中的内容了（为方便我只挂载了一个分区）。</p>\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/03/Task_07_02.png\" alt=\"Task_07_02\"></p>\n<p>从图上可以看到一个warning：“/media/NAS seems to be mounted read-only”。这是因为挂载的这个分区NTFS格式的。若要可读可写，可以安装ntfs-3g来实现。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">sudo</span> apt-get install ntfs-<span class=\"number\">3</span>g</div><div class=\"line\"><span class=\"built_in\">sudo</span> mount -t ntfs-<span class=\"number\">3</span>g -o uid=pi,gid=pi /dev/sda5 /media/NAS</div></pre></td></tr></table></figure>\n\n<p>若要实现开机自动挂载移动硬盘，可以修改/etc/fstab文件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">sudo</span> vim /etc/fstab</div></pre></td></tr></table></figure>\n\n<p>添加如下内容：</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"regexp\">/dev/</span>sda5 <span class=\"regexp\">/media/</span>NAS auto defaults,noexec,umask=<span class=\"number\">0000</span> <span class=\"number\">0</span> <span class=\"number\">0</span></div></pre></td></tr></table></figure>\n\n<p>然后重启即可。</p>\n<hr>\n<p><strong>通过Samba访问。</strong><br>Samba，是种用来让UNIX系列的操作系统与微软Windows操作系统的SMB/CIFS（Server Message Block/Common Internet File System）网络协定做连结的自由软件。目前的版本（v3）不仅可存取及分享SMB的资料夹及打印机，本身还可以整合入Windows Server的网域，扮演为网域控制站（Domain Controller）以及加入Active Directory成员。简而言之，此软件在Windows与UNIX系列OS之间搭起一座桥梁，让两者的资源可互通有无。<br>下面就来说说如何在RPi上安装并使用Samba。</p>\n<ul>\n<li>安装Samba，并把把系统默认用户 pi 添加到 samba</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">sudo</span> apt-get install samba samba-common-bin</div><div class=\"line\"><span class=\"built_in\">sudo</span> smbpasswd <span class=\"operator\">-a</span> pi</div></pre></td></tr></table></figure>\n\n<ul>\n<li>修改Samba的配置文件：/etc/samba/smb.conf，在最后加上以下内容</li>\n</ul>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[NAS]</div><div class=\"line\"><span class=\"variable\">comment =</span> NAS</div><div class=\"line\"><span class=\"variable\">public =</span> yes</div><div class=\"line\"><span class=\"variable\">path =</span> /media/NAS    <span class=\"comment\"># 根据实际情况填写</span></div><div class=\"line\">valid <span class=\"variable\">users =</span> pi</div><div class=\"line\">read <span class=\"variable\">only =</span> no</div></pre></td></tr></table></figure>\n\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/03/Task_07_04.png\" alt=\"Task_07_04\"></p>\n<ul>\n<li>重启Samba服务</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">sudo</span> service samba restart</div></pre></td></tr></table></figure>\n\n<ul>\n<li>使用windows连接RPi</li>\n</ul>\n<p>按快捷键Win+R或者打开资源管理器，访问”\\IP”，如下图所示。</p>\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/03/Task_07_06.png\" alt=\"Task_07_06\"></p>\n<p>根据提示输入用户名和密码（必须是使用sampasswd添加过的账户）登录，即可看到移动硬盘中的内容了。</p>\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/03/Task_07_09.png\" alt=\"Task_07_09\"></p>\n<hr>\n<p><strong>通过SFTP访问。</strong><br>SFTP（SSH File Transfer Protocol）是一种基于SSH的文件传输协议，透过SSH 2.0 的扩充提供安全档案传输能力。因为RPi默认已经开启了SSH，所以我们可以直接使用。</p>\n<p>以WinSCP为例。</p>\n<ul>\n<li>打开WinSCP，点击右上角的新建按钮，填入服务器信息；</li>\n</ul>\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/03/Unnamed-QQ-Screenshot20130301234118.png\" alt=\"\"></p>\n<ul>\n<li>输入完毕后点击保存，（可以选择保存密码），选择刚刚新建的会话，点击登录；</li>\n</ul>\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/03/Unnamed-QQ-Screenshot20130301222639.png\" alt=\"\"></p>\n<ul>\n<li>定位到/media/NAS目录，即可查看到移动硬盘中的内容。</li>\n</ul>\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/03/Task_07_12.png\" alt=\"Task_07_12\"></p>\n<hr>\n<p>通过DLNA访问。</p>\n<ul>\n<li>安装minidlna</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">sudo</span> apt-get install minidlna</div></pre></td></tr></table></figure>\n\n<ul>\n<li>编辑minidlna的配置文件 /etc/minidlna.conf</li>\n</ul>\n<p>找到“media_dir”项，修改为移动硬盘的挂载点，比如我的/media/NAS。</p>\n<ul>\n<li>重启minidlna服务</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"built_in\">sudo</span> service minidlna restart</div></pre></td></tr></table></figure>\n\n<ul>\n<li>在浏览器里输入”IP:8200”，查看服务器状态（8200为默认端口）。</li>\n</ul>\n<p><img src=\"http://img.nilennoct.com/wp-content/uploads/2013/03/Task_07_131.png\" alt=\"Task_07_13\"></p>\n","layout":"post"}